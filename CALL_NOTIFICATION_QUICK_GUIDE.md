# Call Notification - Visual Guide & Quick Reference

## ðŸŽ¯ What Changed

### BEFORE
```
Video Chat Dialog
â”œâ”€â”€ Pre-Call State
â”œâ”€â”€ Calling State
â”œâ”€â”€ Incoming Call State
â”‚   â”œâ”€â”€ Camera preference checkbox
â”‚   â”œâ”€â”€ [Answer Call] button      â† Inside dialog
â”‚   â””â”€â”€ [Decline] button          â† Inside dialog
â”œâ”€â”€ Active Call State
â””â”€â”€ Call Ended
```

### AFTER
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ“ž Doctor is calling...                                    â”‚
â”‚ [Answer âœ“]  [Decline âœ—]        â† TOP OF SCREEN - ALWAYS    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
          (Click Answer to proceed)
                         â†“
Video Chat Dialog
â”œâ”€â”€ Pre-Call State
â”œâ”€â”€ Calling State
â”œâ”€â”€ Incoming Call State (Simplified)
â”‚   â”œâ”€â”€ Camera preference checkbox
â”‚   â””â”€â”€ "Check notification at top" message
â”œâ”€â”€ Active Call State
â””â”€â”€ Call Ended
```

## ðŸ“± Visual Layout

### Notification Display
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“   â”‚
â”‚  â”ƒ  ðŸ“ž  Dr. Smith is calling                    â”‚ âœ“  â”‚  âœ—  â”ƒ   â”‚
â”‚  â”ƒ      Incoming Video Call                                  â”ƒ   â”‚
â”‚  â”ƒ      Appointment ID: appt_123456                         â”ƒ   â”‚
â”‚  â”ƒ      â—¯ â—¯ â—¯  (ringing dots)                              â”ƒ   â”‚
â”‚  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›   â”‚
â”‚                                                                   â”‚
â”‚                        [Rest of page]                           â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ”„ Call Flow Diagram

### Patient Perspective (Receives Call)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Patient on Dashboard            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Doctor initiates call
               â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Notification appearsâ”‚
      â”‚ at TOP of screen    â”‚
      â”‚ ðŸ“ž Doctor calling..â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
             â”‚          â”‚
        Clickâ”‚          â”‚Click
        Answerâ”‚          â”‚Decline
             â†“          â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Call    â”‚  â”‚ Call Ended â”‚
        â”‚ Accepted â”‚  â”‚ (Declined) â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
        Video Chat Opens
             â†“
        Live Video Stream
             â†“
        Call Active
```

### Doctor Perspective (Initiates Call)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Doctor in Video Chat Dialog      â”‚
â”‚                                  â”‚
â”‚ [Start Call] button clicked      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Dialog shows:        â”‚
        â”‚ "Calling Patient..." â”‚
        â”‚ [Cancel button]      â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ (Wait max 30 seconds)
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                 â”‚
        â”‚ Patient answers  â”‚ No response or  â”‚
        â”‚                  â”‚ Patient declinesâ”‚
        â†“                  â†“                 â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Video  â”‚      â”‚ Call     â”‚    â”‚ Call       â”‚
     â”‚ Stream â”‚      â”‚ Timeout  â”‚    â”‚ Declined   â”‚
     â”‚ Starts â”‚      â”‚ Msg      â”‚    â”‚ Msg        â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸŽ¨ User Interactions

### Answering a Call
```
1. Notification appears at top
   â†“
2. User sees caller name and appointment info
   â†“
3. User clicks green "Answer" button
   â†“
4. Camera preference dialog shows (in the main dialog)
   â†“
5. User can select camera on/off before answering
   â†“
6. Click "Answer Call" in dialog (or already answered from notification)
   â†“
7. Connection established
   â†“
8. Video stream begins
   â†“
9. Call controls appear (mute, video toggle, end call)
```

### Declining a Call
```
1. Notification appears at top
   â†“
2. User sees caller details
   â†“
3. User clicks red "Decline" button
   â†“
4. Notification disappears
   â†“
5. Call is rejected (remote peer gets "call rejected" message)
   â†“
6. Dialog closes automatically
```

## ðŸ”Š Audio & Notifications

### Notification Sound
- Plays automatically when call arrives
- 500ms beeping tone
- Gracefully handles if audio context unavailable
- No error shown to user

### Sound Code
```javascript
const audioContext = new AudioContext();
const oscillator = audioContext.createOscillator();
oscillator.frequency.value = 800; // Hz
oscillator.start();
oscillator.stop(currentTime + 0.5); // 500ms duration
```

## ðŸ“Š State Machine

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Pre-Call    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                    â”‚             â”‚
                    â†“             â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Calling    â”‚ â”‚  Answering   â”‚
            â”‚  (Initiator) â”‚ â”‚  (Receiver)  â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                  â”‚
        â”‚ Answer received    â”‚ User clicks     â”‚
        â”‚                    â”‚ Answer button   â”‚
        â”‚                    â”‚                 â”‚
        â†“                    â†“                 â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚     Call Active (Connected)        â”‚  â”‚ Declinedâ”‚
   â”‚ - Video streams flowing            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ - Audio enabled                    â”‚
   â”‚ - Call duration tracking           â”‚
   â”‚ - Media controls available         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ User clicks End Call
              â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Call End â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ› ï¸ Component Integration

```
App.tsx
â”œâ”€â”€ CallNotificationProvider (Context)
â”‚   â””â”€â”€ GlobalCallNotification (Component)
â”‚       â””â”€â”€ IncomingCallNotification
â”‚           â”œâ”€â”€ Display banner at top
â”‚           â”œâ”€â”€ Show caller info
â”‚           â”œâ”€â”€ Answer button
â”‚           â”œâ”€â”€ Decline button
â”‚           â””â”€â”€ Play notification sound
â”‚
â””â”€â”€ Routes
    â””â”€â”€ Dashboard/DoctorDashboard
        â””â”€â”€ VideoChatDialog
            â”œâ”€â”€ useWebRTCCall hook
            â”‚   â”œâ”€â”€ Setup offer/answer signaling
            â”‚   â”œâ”€â”€ Manage WebRTC connection
            â”‚   â””â”€â”€ Set incomingCall state
            â”‚
            â””â”€â”€ VideoChat
                â”œâ”€â”€ Display video streams
                â”œâ”€â”€ Show call controls
                â””â”€â”€ Handle camera preferences
```

## ðŸ“‹ Key Files

| File | Purpose | Changes |
|------|---------|---------|
| `IncomingCallNotification.tsx` | Display notification banner | NEW |
| `CallNotificationContext.tsx` | Global state management | MODIFIED |
| `use-webrtc-call.ts` | WebRTC signaling | MODIFIED - Added incoming call state |
| `VideoChatDialog.tsx` | Dialog wrapper | MODIFIED - Integrated context |
| `VideoChat.tsx` | Video UI | MODIFIED - Removed dialog buttons |
| `App.tsx` | App root | MODIFIED - Added provider & notification |

## âœ¨ Features Summary

âœ… **Answer/Decline at Top**
- Notification banner at top of screen
- Always visible and accessible
- Works on any page

âœ… **Proper Call Handling**
- Incoming vs outgoing distinction
- Timeout after 30 seconds
- State management for all phases
- Clean error handling

âœ… **Audio Notification**
- Automatic beep on incoming call
- Web Audio API integration
- Graceful degradation

âœ… **Mobile Friendly**
- Responsive buttons
- Touch-friendly interface
- Works portrait and landscape

âœ… **User Feedback**
- Visual animations
- Status messages
- Call information display
- Ringing indicator

## ðŸš€ How to Test

### Test 1: Basic Incoming Call
1. Open two browsers/devices
2. Login as doctor and patient
3. Doctor initiates call to patient
4. Patient should see notification at top
5. Click Answer
6. Video should connect

### Test 2: Decline Call
1. Repeat steps 1-4 above
2. Click Decline button
3. Notification should disappear
4. Doctor should get "declined" message

### Test 3: Call Timeout
1. Doctor initiates call
2. Patient doesn't answer
3. After 30 seconds, doctor gets timeout message

### Test 4: Mobile Response
1. Open patient view on mobile
2. Receive incoming call
3. Verify notification appears fully visible
4. Verify buttons are easy to tap

## ðŸŽ“ Usage Example

```tsx
// In VideoChatDialog component
const { setIncomingCall } = useCallNotification();

useEffect(() => {
  if (callState.incomingCall) {
    setIncomingCall({
      callerName: callState.callerName,
      appointmentId,
      onAnswer: async () => {
        await callActions.answerCall();
      },
      onDecline: () => {
        callActions.dismissIncomingCall();
      },
    });
  }
}, [callState.incomingCall]);
```

## ðŸ“ž API Reference

### useCallNotification Hook
```tsx
const { incomingCall, setIncomingCall } = useCallNotification();

// incomingCall object
{
  isActive: boolean;           // Is notification showing?
  callerName: string;          // Who's calling?
  appointmentId: string;       // Which appointment?
  onAnswer: () => void;        // Answer button handler
  onDecline: () => void;       // Decline button handler
}

// Update notification
setIncomingCall({
  callerName: "Dr. Smith",
  appointmentId: "appt_123",
  onAnswer: () => { /* handle */ },
  onDecline: () => { /* handle */ },
});

// Clear notification
setIncomingCall(null);
```

### useWebRTCCall Hook
```tsx
// New state properties
callState.incomingCall: boolean;
callState.callerName: string | null;

// New action
callActions.dismissIncomingCall(): void;
```

---

**Status:** âœ… Complete and ready to use
**Last Updated:** December 28, 2025
